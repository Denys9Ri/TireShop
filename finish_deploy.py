import os
import django
from django.core.management import call_command
from django.db import connection

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'TireShop.settings')
django.setup()

print("üöÄ –ü–æ—á–∏–Ω–∞—é —Ä—É—á–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö...")

# 1. "–§–µ–π–∫–æ–≤–∞" –º—ñ–≥—Ä–∞—Ü—ñ—è
# –ú–∏ –∫–∞–∂–µ–º–æ Django, —â–æ –º—ñ–≥—Ä–∞—Ü—ñ—è 0007 –≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω–∞. 
# –¶–µ –ø—Ä–∏–±–∏—Ä–∞—î –ø–æ–º–∏–ª–∫–∏ "table already exists" –¥–ª—è –ë–∞–Ω–µ—Ä–∞ —ñ –ö—Ä–∞—ó–Ω–∏.
try:
    print("--> –ú–∞—Ä–∫—É—î–º–æ –º—ñ–≥—Ä–∞—Ü—ñ—é 0007 —è–∫ –≤–∏–∫–æ–Ω–∞–Ω—É...")
    call_command('migrate', 'store', '0007', fake=True)
    print("OK.")
except Exception as e:
    print(f"–£–≤–∞–≥–∞ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ): {e}")

# 2. –î–æ—Å—Ç–≤–æ—Ä—é—î–º–æ —Ç–µ, —â–æ –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ (–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —ñ –ó–Ω–∏–∂–∫–∏)
# –û—Å–∫—ñ–ª—å–∫–∏ –º–∏ –∑—Ä–æ–±–∏–ª–∏ 'fake', Django –Ω–µ —Å—Ç–≤–æ—Ä–∏–≤ –Ω–æ–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ. –†–æ–±–∏–º–æ —Ü–µ –≤—Ä—É—á–Ω—É SQL-–∫–æ–¥–æ–º.
with connection.cursor() as cursor:
    print("--> –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ SiteSettings...")
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS store_sitesettings (
            id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
            global_markup numeric(5, 2) NOT NULL
        );
    ''')
    
    print("--> –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–ª–æ–Ω–∫–∏ –∑–Ω–∏–∂–∫–∏ (discount_percent)...")
    try:
        cursor.execute('ALTER TABLE store_product ADD COLUMN IF NOT EXISTS discount_percent integer NOT NULL DEFAULT 0;')
    except Exception:
        # –Ø–∫—â–æ –∫–æ–ª–æ–Ω–∫–∞ –≤–∂–µ —î, —ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫—É
        pass

print("‚úÖ –£—Å–ø—ñ—à–Ω–æ! –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –ø–æ–≤–Ω—ñ—Å—Ç—é —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∞.")
