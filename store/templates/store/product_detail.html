{% extends 'store/base.html' %}
{% load static %}

{% block title %}{{ product.brand.name|default_if_none:'' }} {{ product.name }} - ShinaMania.ua{% endblock %}

{% block content %}
<div class="product-detail">
    <a href="{% url 'catalog' %}" class="back-link">← Повернутися до каталогу</a>
    <div class="product-detail__header">
        <div class="product-detail__image">
            {% if product.photo_url %}
                {% if product.photo_url.url %}
                    <img src="{{ product.photo_url.url }}" alt="{{ product.name }}" class="zoomable-image" data-fullsrc="{{ product.photo_url.url }}">
                {% else %}
                    <img src="{{ product.photo_url }}" alt="{{ product.name }}" class="zoomable-image" data-fullsrc="{{ product.photo_url }}">
                {% endif %}
            {% else %}
                <img src="{% static 'images/no-image.png' %}" alt="Немає фото" class="zoomable-image" data-fullsrc="{% static 'images/no-image.png' %}">
            {% endif %}
        </div>
        <div class="product-detail__info">
            <h1>{{ product.brand.name|default_if_none:'' }} {{ product.name }}</h1>
            <p class="product-detail__specs">{{ product.width }}/{{ product.profile }} R{{ product.diameter }} ({{ product.get_seasonality_display }})</p>
            <p class="product-detail__price">{{ product.price|floatformat:2 }} грн</p>
            <div class="product-detail__stock">Наявність: {{ product.stock_quantity }} шт.</div>
            <form action="{% url 'store:cart_add' product.id %}" method="post" class="product-detail__cart-form">
                {% csrf_token %}
                <label class="quantity-field">
                    <span>Кількість</span>
                    <div class="quantity-stepper">
                        <button type="button" class="quantity-btn" data-direction="decrease" aria-label="Зменшити кількість">−</button>
                        <input type="number" name="quantity" value="1" min="1" max="{{ product.stock_quantity|default_if_none:99 }}" aria-label="Кількість">
                        <button type="button" class="quantity-btn" data-direction="increase" aria-label="Збільшити кількість">+</button>
                    </div>
                </label>
                <button type="submit" class="add-to-cart-btn">Додати в кошик</button>
            </form>
        </div>
    </div>

    {% if product.description %}
    <div class="product-detail__section">
        <h2>Опис</h2>
        <div class="product-detail__description">{{ product.description|linebreaks }}</div>
    </div>
    {% endif %}

    {% with product.images.all as gallery %}
    {% if gallery %}
    <div class="product-detail__section">
        <h2>Додаткові фото</h2>
        <div class="product-detail__gallery">
            {% for image in gallery %}
                <img src="{{ image.image_url }}" alt="{{ product.name }} фото {{ forloop.counter }}" class="zoomable-image" data-fullsrc="{{ image.image_url }}">
            {% empty %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endwith %}

    <div class="image-modal" id="imageModal" aria-hidden="true">
        <div class="image-modal__backdrop" data-close-modal></div>
        <div class="image-modal__content" role="dialog" aria-modal="true" aria-label="Збільшене фото">
            <button type="button" class="image-modal__close" data-close-modal>&times;</button>
            <img src="" alt="Збільшене фото" id="imageModalImg">
        </div>
    </div>
</div>

<script>
    (function() {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('imageModalImg');
        const zoomableImages = document.querySelectorAll('.zoomable-image');

        function openModal(src, alt) {
            modalImg.src = src;
            modalImg.alt = alt || 'Збільшене фото';
            modal.setAttribute('aria-hidden', 'false');
            modal.classList.add('is-active');
        }

        function closeModal() {
            modal.classList.remove('is-active');
            modal.setAttribute('aria-hidden', 'true');
            modalImg.src = '';
        }

        zoomableImages.forEach((img) => {
            img.addEventListener('click', () => {
                const fullSrc = img.dataset.fullsrc || img.src;
                openModal(fullSrc, img.alt);
            });
        });

        modal.addEventListener('click', (event) => {
            if (event.target.dataset.closeModal !== undefined || event.target === modal) {
                closeModal();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modal.classList.contains('is-active')) {
                closeModal();
            }
        });

        // Степер кількості для сторінки товару
        const quantityStepper = document.querySelector('.product-detail__cart-form .quantity-stepper');
        if (quantityStepper) {
            const input = quantityStepper.querySelector('input[name="quantity"]');
            const buttons = quantityStepper.querySelectorAll('.quantity-btn');

            buttons.forEach((button) => {
                button.addEventListener('click', () => {
                    const direction = button.dataset.direction;
                    const min = parseInt(input.getAttribute('min'), 10) || 1;
                    const max = parseInt(input.getAttribute('max'), 10) || 99;
                    const current = parseInt(input.value, 10) || min;
                    let next = current;

                    if (direction === 'increase' && current < max) {
                        next = current + 1;
                    }
                    if (direction === 'decrease' && current > min) {
                        next = current - 1;
                    }

                    input.value = next;
                });
            });

            input.addEventListener('change', () => {
                const min = parseInt(input.getAttribute('min'), 10) || 1;
                const max = parseInt(input.getAttribute('max'), 10) || 99;
                let value = parseInt(input.value, 10) || min;
                value = Math.min(Math.max(value, min), max);
                input.value = value;
            });
        }
    })();
</script>
{% endblock %}
