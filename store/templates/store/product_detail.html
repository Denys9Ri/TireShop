{% extends 'store/base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row product-detail">
        <div class="col-md-6 mb-4">
            <div class="product-media">
                {% if product.photo_url %}
                    {% with image_source=product.photo_url %}
                        <img src="{{ image_source }}" class="product-image" alt="{{ product.name }}"
                             onerror="this.onerror=null;this.src='https://placehold.co/600x400?text=Error+Loading+URL';">
                        <button class="zoom-trigger" type="button" data-zoom-source="{{ image_source }}">
                            –ó–±—ñ–ª—å—à–∏—Ç–∏ —Ñ–æ—Ç–æ
                        </button>
                    {% endwith %}

                {% elif product.photo %}
                    {% with image_source=product.photo.url %}
                        <img src="{{ image_source }}" class="product-image" alt="{{ product.name }}"
                             onerror="this.onerror=null;this.src='https://placehold.co/600x400?text=File+Deleted+by+Server';">
                        <button class="zoom-trigger" type="button" data-zoom-source="{{ image_source }}">
                            –ó–±—ñ–ª—å—à–∏—Ç–∏ —Ñ–æ—Ç–æ
                        </button>
                    {% endwith %}

                {% else %}
                    <img src="https://placehold.co/600x400?text=No+Photo" class="product-image" alt="No image">
                {% endif %}
            </div>

            <div class="image-lightbox" id="product-image-lightbox" aria-hidden="true">
                <div class="image-lightbox__backdrop"></div>
                <div class="image-lightbox__dialog" role="dialog" aria-modal="true" aria-label="–î–µ—Ç–∞–ª—å–Ω–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä—É">
                    <button type="button" class="image-lightbox__close" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
                    <img src="" alt="{{ product.name }}" class="image-lightbox__image">
                </div>
            </div>

        </div>

        <div class="col-md-6">
            <h1 class="mb-2">{{ product.brand.name }} {{ product.name }}</h1>
            <p class="text-muted mb-4" style="font-size: 1.2rem;">
                {{ product.width }} / {{ product.profile }} R{{ product.diameter }}
            </p>

            <h2 class="text-primary mb-3">{{ product.price }} –≥—Ä–Ω</h2>

            {% if product.stock_quantity > 0 %}
                <span class="badge bg-success mb-4 p-2">–Ñ –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
            {% else %}
                <span class="badge bg-secondary mb-4 p-2">–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
            {% endif %}

            <form action="{% url 'store:cart_add' product.id %}" method="post" class="d-flex gap-2 mb-5">
                {% csrf_token %}
                <input type="number" name="quantity" value="1" min="1" class="form-control" style="width: 80px;">
                <button type="submit" class="btn btn-primary flex-grow-1">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
            </form>

            <h3 class="mb-3">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
            
            <style>
                .specs-list {
                    list-style: none;
                    padding: 0;
                    margin: 0;
                }
                .specs-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: baseline;
                    margin-bottom: 12px;
                }
                .specs-label {
                    color: #666;
                    flex-shrink: 0; /* –©–æ–± –Ω–∞–∑–≤–∞ –Ω–µ –∑–∂–∏–º–∞–ª–∞—Å—å */
                }
                .specs-dots {
                    flex-grow: 1; /* –ó–∞–π–º–∞—î –≤—Å–µ –≤—ñ–ª—å–Ω–µ –º—ñ—Å—Ü–µ */
                    border-bottom: 1px dotted #ccc; /* –¢—ñ —Å–∞–º—ñ –∫—Ä–∞–ø–æ—á–∫–∏ */
                    margin: 0 10px;
                    position: relative;
                    top: -5px; /* –¢—Ä–æ—à–∫–∏ –ø—ñ–¥–Ω—è—Ç–∏ –∫—Ä–∞–ø–∫–∏ */
                }
                .specs-value {
                    font-weight: 500;
                    color: #333;
                    text-align: right;
                }
            </style>

            <ul class="specs-list">
                <li class="specs-item">
                    <span class="specs-label">–†—ñ–∫ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value">{{ product.year }}</span>
                </li>
                <li class="specs-item">
                    <span class="specs-label">–ö—Ä–∞—ó–Ω–∞ –≤–∏—Ä–æ–±–Ω–∏–∫</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value">
                        {% if product.country == '–ù—ñ–º–µ—á—á–∏–Ω–∞' %}üá©üá™{% endif %}
                        {{ product.country }}
                    </span>
                </li>
                <li class="specs-item">
                    <span class="specs-label">–í–∏—Ä–æ–±–Ω–∏–∫</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value text-primary">{{ product.brand.name }}</span>
                </li>
                <li class="specs-item">
                    <span class="specs-label">–ú–æ–¥–µ–ª—å</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value text-primary">{{ product.name }}</span>
                </li>
                <li class="specs-item">
                    <span class="specs-label">–°–µ–∑–æ–Ω</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value">
                        {% if product.seasonality == 'winter' %}‚ùÑÔ∏è –ó–∏–º–æ–≤—ñ
                        {% elif product.seasonality == 'summer' %}‚òÄÔ∏è –õ—ñ—Ç–Ω—ñ
                        {% else %}üå§ –í—Å–µ—Å–µ–∑–æ–Ω–Ω—ñ{% endif %}
                    </span>
                </li>
                <li class="specs-item">
                    <span class="specs-label">–¢–∏–ø –¢/–ó</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value">{{ product.vehicle_type }}</span>
                </li>
                <li class="specs-item">
                    <span class="specs-label">–®–∏—Ä–∏–Ω–∞</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value">{{ product.width }}</span>
                </li>
                <li class="specs-item">
                    <span class="specs-label">–ü—Ä–æ—Ñ—ñ–ª—å</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value">{{ product.profile }}</span>
                </li>
                <li class="specs-item">
                    <span class="specs-label">–î—ñ–∞–º–µ—Ç—Ä</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value text-primary">R{{ product.diameter }}</span>
                </li>
                <li class="specs-item">
                    <span class="specs-label">–®–∏–ø–∏</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value">{{ product.stud_type }}</span>
                </li>
                <li class="specs-item">
                    <span class="specs-label">–Ü–Ω–¥–µ–∫—Å –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value">{{ product.load_index }}</span>
                </li>
                <li class="specs-item">
                    <span class="specs-label">–Ü–Ω–¥–µ–∫—Å —à–≤–∏–¥–∫–æ—Å—Ç—ñ</span>
                    <span class="specs-dots"></span>
                    <span class="specs-value">{{ product.speed_index }}</span>
                </li>
            </ul>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const lightbox = document.getElementById('product-image-lightbox');
        const lightboxImage = lightbox?.querySelector('.image-lightbox__image');
        const closeButton = lightbox?.querySelector('.image-lightbox__close');
        const triggers = document.querySelectorAll('[data-zoom-source]');

        if (!lightbox || !lightboxImage) {
            return;
        }

        const openLightbox = (source) => {
            lightboxImage.src = source;
            lightbox.classList.add('is-visible');
            lightbox.setAttribute('aria-hidden', 'false');
            document.body.classList.add('no-scroll');
        };

        const closeLightbox = () => {
            lightbox.classList.remove('is-visible');
            lightbox.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('no-scroll');
        };

        triggers.forEach((trigger) => {
            trigger.addEventListener('click', () => {
                const source = trigger.getAttribute('data-zoom-source');
                if (source) {
                    openLightbox(source);
                }
            });
        });

        closeButton?.addEventListener('click', closeLightbox);

        lightbox.addEventListener('click', (event) => {
            if (event.target === lightbox || event.target.classList.contains('image-lightbox__backdrop')) {
                closeLightbox();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && lightbox.classList.contains('is-visible')) {
                closeLightbox();
            }
        });
    });
</script>
{% endblock %}
